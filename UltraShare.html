<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>UltraShare Pro v8</title>
<meta name="theme-color" content="#2563eb">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<style>
/* --- DESIGN SYSTEM --- */
:root {
  --primary: #2563eb; --primary-dark: #1e40af;
  --bg-body: #f1f5f9; --bg-card: #ffffff;
  --text-main: #0f172a; --text-light: #64748b;
  --success: #10b981; --error: #ef4444; --warn: #f59e0b;
  --font: 'Inter', system-ui, sans-serif;
}
@media (prefers-color-scheme: dark) {
  :root { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-light: #94a3b8; }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: var(--font); background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

/* LAYOUT */
.app-header { padding: 16px 20px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
.logo { font-weight: 800; font-size: 20px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.status-pill { font-size: 11px; padding: 4px 10px; border-radius: 20px; background: var(--bg-body); font-weight: 600; display: flex; align-items: center; gap: 6px; }
.dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-light); transition: 0.3s; }
.dot.green { background: var(--success); box-shadow: 0 0 8px var(--success); }
.dot.orange { background: var(--warn); animation: pulse 1s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

.main-view { flex: 1; overflow-y: auto; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; display: none; }
.main-view.active { display: block; animation: fadeUp 0.3s ease; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

/* COMPONENTS */
.card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
h2 { font-size: 14px; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; margin: 0 0 12px 0; }

.code-display { font-size: 32px; font-weight: 900; color: var(--primary); letter-spacing: 4px; text-align: center; margin: 10px 0; font-family: monospace; }
.input-code { width: 100%; font-size: 20px; padding: 14px; text-align: center; border-radius: 12px; border: 2px solid var(--bg-body); background: var(--bg-body); color: var(--text-main); font-family: monospace; letter-spacing: 2px; outline: none; transition: 0.2s; }
.input-code:focus { border-color: var(--primary); background: var(--bg-card); }

.btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s; background: var(--primary); color: white; margin-top: 10px; }
.btn:disabled { opacity: 0.7; cursor: not-allowed; }
.btn:active { transform: scale(0.98); }

/* LOGGER (The "Doctor") */
.console-log { font-family: monospace; font-size: 11px; color: var(--text-light); background: var(--bg-body); padding: 10px; border-radius: 8px; max-height: 100px; overflow-y: auto; margin-top: 10px; border: 1px solid rgba(0,0,0,0.05); }
.log-line { margin-bottom: 4px; border-bottom: 1px solid rgba(0,0,0,0.03); padding-bottom: 2px; }
.log-line.error { color: var(--error); }
.log-line.success { color: var(--success); }

/* FILE & CHAT */
.file-drop { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; }
.file-list { margin-top: 16px; }
.file-item { display: flex; align-items: center; padding: 12px; background: var(--bg-body); border-radius: 8px; margin-bottom: 8px; gap: 10px; }
.chat-box { height: 300px; display: flex; flex-direction: column; }
.messages { flex: 1; overflow-y: auto; padding: 10px; background: var(--bg-body); border-radius: 12px; margin-bottom: 10px; }
.bubble { padding: 8px 12px; border-radius: 12px; max-width: 80%; margin-bottom: 8px; font-size: 14px; word-break: break-word; }
.bubble.mine { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; }
.bubble.theirs { background: var(--bg-card); border: 1px solid #e2e8f0; align-self: flex-start; }

/* NAV */
.nav { position: fixed; bottom: 0; width: 100%; background: var(--bg-card); border-top: 1px solid rgba(0,0,0,0.05); display: flex; padding-bottom: env(safe-area-inset-bottom); height: 70px; }
.nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-light); font-size: 10px; font-weight: 600; }
.nav-btn.active { color: var(--primary); }
.nav-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }

/* NOTIFICATIONS */
#toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99; display: flex; flex-direction: column; gap: 8px; width: 90%; pointer-events: none; }
.toast { background: rgba(0,0,0,0.9); color: white; padding: 12px 20px; border-radius: 30px; font-size: 13px; backdrop-filter: blur(4px); text-align: center; animation: slideIn 0.3s; }
@keyframes slideIn { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1}}

</style>
</head>
<body>

<div class="app-header">
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
    UltraShare <span style="font-size:10px; opacity:0.6; margin-top:4px;">PRO</span>
  </div>
  <div class="status-pill">
    <div id="statusDot" class="dot"></div>
    <span id="statusText">Init...</span>
  </div>
</div>

<div id="tab-connect" class="main-view active">
  <div class="card" style="text-align: center;">
    <h2>Your Code</h2>
    <div id="myId" class="code-display">...</div>
    <div style="font-size: 12px; color: var(--text-light);">Share this with your partner</div>
  </div>

  <div class="card">
    <h2>Connect to Partner</h2>
    <input type="tel" id="destId" class="input-code" placeholder="Enter Partner Code" maxlength="6">
    <button id="btnConnect" class="btn">Connect</button>
    <div id="console" class="console-log">
      <div class="log-line">System ready. Waiting for network...</div>
    </div>
  </div>
</div>

<div id="tab-send" class="main-view">
  <div class="card">
    <div class="file-drop" onclick="document.getElementById('fileIn').click()">
      <div style="font-size:32px; margin-bottom:10px;">ðŸ“‚</div>
      <strong>Tap to select files</strong>
    </div>
    <input type="file" id="fileIn" multiple style="display:none">
    
    <div id="fileQueue" class="file-list"></div>
    <button id="btnSend" class="btn" style="display:none;">Send Files</button>
  </div>
  
  <div id="transferCard" class="card" style="display:none;">
    <h2>Transfer Progress</h2>
    <div style="height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
      <div id="progressBar" style="width:0%; height:100%; background:var(--primary); transition: width 0.1s;"></div>
    </div>
    <div id="transferText" style="font-size:12px; color:var(--text-light); margin-top:8px; display:flex; justify-content:space-between;">
      <span>Sending...</span><span>0%</span>
    </div>
  </div>
</div>

<div id="tab-chat" class="main-view">
  <div class="card chat-box">
    <div id="msgList" class="messages">
      <div style="text-align:center; padding:20px; color:var(--text-light); font-size:12px;">
        End-to-end encrypted chat.<br>Links open automatically.
      </div>
    </div>
    <div style="display:flex; gap:10px;">
      <input id="msgInput" class="input-code" style="font-size:16px; text-align:left; padding:10px;" placeholder="Message...">
      <button id="btnMsg" class="btn" style="width:auto; margin:0;">âž¤</button>
    </div>
  </div>
</div>

<div id="tab-receive" class="main-view">
  <div class="card">
    <h2>Received Files</h2>
    <div id="receiveList">
      <div style="text-align:center; padding:20px; color:#cbd5e1;">No files received yet</div>
    </div>
  </div>
</div>

<nav class="nav">
  <button class="nav-btn active" onclick="switchTab('tab-connect')">
    <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Connect
  </button>
  <button class="nav-btn" onclick="switchTab('tab-send')">
    <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Send
  </button>
  <button class="nav-btn" onclick="switchTab('tab-chat')">
    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Chat
  </button>
  <button class="nav-btn" onclick="switchTab('tab-receive')">
    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Receive
  </button>
</nav>

<div id="toast-box"></div>

<script>
/* ULTRA-SHARE PRO V8 - NETWORK CORE */

// 1. Force HTTPS (Critical for WebRTC)
if (location.protocol !== 'https:' && location.hostname !== 'localhost' && !location.href.includes('127.0.0.1')) {
  location.replace(`https:${location.href.substring(location.protocol.length)}`);
}

const $ = id => document.getElementById(id);
const myCode = Math.floor(100000 + Math.random() * 900000).toString();
const PREFIX = 'us_v8_'; // Version 8 Prefix
let peer, conn;
let fileQueue = [];
let isSending = false;

// Logging Utility
function log(msg, type='') {
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  line.textContent = `> ${msg}`;
  const c = $('console');
  c.appendChild(line);
  c.scrollTop = c.scrollHeight;
  if(type === 'error') toast(msg);
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  $('toast-box').appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

function updateStatus(state) {
  const d = $('statusDot');
  const t = $('statusText');
  if(state === 'online') { d.className='dot green'; t.textContent='Connected'; $('btnConnect').textContent='Connected'; $('btnConnect').disabled=true; $('destId').disabled=true; }
  else if(state === 'connecting') { d.className='dot orange'; t.textContent='Connecting...'; $('btnConnect').textContent='Working...'; }
  else { d.className='dot'; t.textContent='Ready'; $('btnConnect').textContent='Connect'; $('btnConnect').disabled=false; $('destId').disabled=false; }
}

// 2. NETWORK INIT
function initPeer() {
  log('Initializing Network...');
  
  // Using multiple STUN servers for maximum reliability
  peer = new Peer(PREFIX + myCode, {
    debug: 1,
    pingInterval: 5000,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        { urls: 'stun:stun.nextcloud.com:443' }
      ]
    }
  });

  peer.on('open', (id) => {
    $('myId').textContent = myCode;
    log(`ID Registered: ${myCode}`, 'success');
    updateStatus('ready');
  });

  peer.on('error', (err) => {
    log(`Error: ${err.type}`, 'error');
    if(err.type === 'peer-unavailable') log('Code not found. Is partner online?');
    updateStatus('error');
  });

  peer.on('connection', (c) => {
    log(`Incoming connection...`);
    handleConnection(c);
  });
}

function handleConnection(c) {
  if(conn) conn.close();
  conn = c;

  conn.on('open', () => {
    log('Secure Connection Established!', 'success');
    toast('Connected!');
    updateStatus('online');
    sendData({ type: 'handshake' }); // Wake up call
  });

  conn.on('data', processData);
  conn.on('close', () => {
    log('Connection lost.', 'error');
    updateStatus('ready');
    conn = null;
  });
  conn.on('error', (e) => log(`Conn Error: ${e}`, 'error'));
}

// 3. MANUAL CONNECT
$('btnConnect').onclick = () => {
  const code = $('destId').value.trim();
  if(code.length !== 6) return toast('Code must be 6 digits');
  if(code === myCode) return toast('Cannot connect to yourself');
  
  log(`Searching for ${code}...`);
  updateStatus('connecting');
  
  const c = peer.connect(PREFIX + code, { reliable: true });
  
  // Timeout Failsafe
  const timer = setTimeout(() => {
    if(!c.open) {
      log('Connection Timed Out. Retrying...', 'error');
      c.close();
      updateStatus('ready');
    }
  }, 8000); // 8 seconds timeout

  c.on('open', () => {
    clearTimeout(timer);
    handleConnection(c);
  });
};

// 4. DATA HANDLING
function sendData(data) {
  if(conn && conn.open) conn.send(data);
}

function processData(data) {
  // Binary (File Chunk)
  if(data instanceof ArrayBuffer || data instanceof Uint8Array) {
    receiveChunk(data);
    return;
  }
  
  // JSON
  if(typeof data === 'string') data = JSON.parse(data); // Legacy check
  
  switch(data.type) {
    case 'chat':
      addChat(data.msg, false);
      break;
    case 'file-meta':
      startReceiving(data);
      break;
    case 'file-chunk': // Fallback for some browsers
      receiveChunk(data.chunk);
      break;
  }
}

// 5. FILE TRANSFER ENGINE
const CHUNK_SIZE = 16 * 1024; // 16KB (Safe for all browsers)

$('fileIn').onchange = (e) => {
  fileQueue = [...e.target.files];
  updateFileUI();
};

function updateFileUI() {
  const q = $('fileQueue');
  q.innerHTML = '';
  fileQueue.forEach(f => {
    const d = document.createElement('div');
    d.className = 'file-item';
    d.innerHTML = `<span>ðŸ“„ ${f.name}</span> <small>${(f.size/1024/1024).toFixed(1)} MB</small>`;
    q.appendChild(d);
  });
  $('btnSend').style.display = fileQueue.length ? 'block' : 'none';
}

$('btnSend').onclick = async () => {
  if(!conn || !conn.open) return toast('Connect first!');
  if(isSending) return;
  isSending = true;
  $('btnSend').disabled = true;
  $('transferCard').style.display = 'block';
  
  for(let file of fileQueue) {
    log(`Sending ${file.name}...`);
    sendData({ type: 'file-meta', name: file.name, size: file.size, mime: file.type });
    
    // Allow UI to update
    await new Promise(r => setTimeout(r, 100));
    
    let offset = 0;
    while(offset < file.size) {
      const slice = file.slice(offset, offset + CHUNK_SIZE);
      const buff = await slice.arrayBuffer();
      
      // Wait if buffer is full (Backpressure)
      if(conn.dataChannel.bufferedAmount > 16000000) {
        await new Promise(r => setTimeout(r, 50));
      }
      
      conn.send(buff);
      offset += buff.byteLength;
      
      // Update UI every 10 chunks
      if(offset % (CHUNK_SIZE*10) === 0) {
        const pct = Math.round((offset/file.size)*100);
        $('progressBar').style.width = pct + '%';
        $('transferText').children[1].textContent = pct + '%';
      }
    }
    log(`Sent ${file.name}`, 'success');
  }
  
  isSending = false;
  fileQueue = [];
  updateFileUI();
  $('btnSend').disabled = false;
  $('transferCard').style.display = 'none';
  toast('All files sent!');
};

// 6. RECEIVING ENGINE
let incoming = null;
let rxChunks = [];
let rxBytes = 0;

function startReceiving(meta) {
  incoming = meta;
  rxChunks = [];
  rxBytes = 0;
  log(`Receiving ${meta.name}...`, 'success');
  switchTab('tab-receive');
}

function receiveChunk(buff) {
  if(!incoming) return;
  rxChunks.push(buff);
  rxBytes += buff.byteLength;
  
  if(rxBytes >= incoming.size) {
    const blob = new Blob(rxChunks, {type: incoming.mime});
    const url = URL.createObjectURL(blob);
    
    const item = document.createElement('div');
    item.className = 'file-item';
    item.style.justifyContent = 'space-between';
    item.innerHTML = `
      <div>
        <div style="font-weight:bold">${incoming.name}</div>
        <div style="font-size:12px; color:#64748b">${(incoming.size/1024/1024).toFixed(1)} MB</div>
      </div>
      <a href="${url}" download="${incoming.name}" class="btn" style="width:auto; padding:8px 16px;">Download</a>
    `;
    $('receiveList').prepend(item);
    
    incoming = null;
    rxChunks = [];
    toast('File Received!');
  }
}

// 7. CHAT
$('btnMsg').onclick = () => {
  const txt = $('msgInput').value;
  if(!txt) return;
  addChat(txt, true);
  sendData({ type: 'chat', msg: txt });
  $('msgInput').value = '';
};

function addChat(txt, mine) {
  const b = document.createElement('div');
  b.className = `bubble ${mine?'mine':'theirs'}`;
  b.textContent = txt;
  $('msgList').appendChild(b);
  $('msgList').scrollTop = $('msgList').scrollHeight;
  if(!mine) switchTab('tab-chat');
}

// UTILS
function switchTab(id) {
  document.querySelectorAll('.main-view').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
  $(id).classList.add('active');
  // Update Nav Active State
  const idx = ['tab-connect','tab-send','tab-chat','tab-receive'].indexOf(id);
  document.querySelectorAll('.nav-btn')[idx].classList.add('active');
}

// START
initPeer();

</script>
</body>
</html>