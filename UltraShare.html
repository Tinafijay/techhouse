<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>ULTIMATE SHARE PRO - Multi-Method File Transfer</title>
<meta name="theme-color" content="#6366f1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- DESIGN SYSTEM --- */
:root {
  --primary: #6366f1; --primary-dark: #4f46e5;
  --secondary: #10b981; --secondary-dark: #059669;
  --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
  --bg-body: #f8fafc; --bg-card: #ffffff; --bg-dark: #1e293b;
  --text-main: #0f172a; --text-light: #64748b; --text-white: #f8fafc;
  --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --radius: 12px; --radius-lg: 20px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}
@media (prefers-color-scheme: dark) {
  :root { 
    --bg-body: #0f172a; --bg-card: #1e293b; --bg-dark: #0f172a;
    --text-main: #f8fafc; --text-light: #94a3b8; --text-white: #ffffff;
    --border: #334155; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
  }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: var(--font); background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }

/* HEADER */
.app-header { padding: 16px 20px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); z-index: 100; position: relative; }
.logo { font-weight: 900; font-size: 22px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
.logo i { font-size: 26px; }
.status-pill { font-size: 12px; padding: 6px 14px; border-radius: 50px; background: var(--bg-body); font-weight: 600; display: flex; align-items: center; gap: 8px; }
.dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-light); transition: 0.3s; }
.dot.green { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }
.dot.orange { background: var(--warning); animation: pulse 1.5s infinite; }
.dot.red { background: var(--danger); animation: pulse 0.8s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

/* TABS */
.tabs { display: flex; background: var(--bg-card); border-bottom: 1px solid var(--border); overflow-x: auto; padding: 0 10px; }
.tab-btn { padding: 16px 20px; background: none; border: none; font-weight: 600; font-size: 14px; color: var(--text-light); white-space: nowrap; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-btn i { font-size: 16px; }

/* MAIN CONTENT */
.main-content { flex: 1; overflow-y: auto; padding: 20px; }
.tab-content { display: none; max-width: 800px; margin: 0 auto; width: 100%; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

/* CARDS */
.card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.card-title { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0; }
.card-subtitle { font-size: 13px; color: var(--text-light); margin-top: 4px; }

/* BUTTONS */
.btn { padding: 14px 24px; border-radius: var(--radius); border: none; font-weight: 600; font-size: 15px; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
.btn-secondary { background: var(--secondary); color: white; }
.btn-secondary:hover { background: var(--secondary-dark); transform: translateY(-2px); }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.btn-outline:hover { background: var(--primary); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-block { width: 100%; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
.btn-sm { padding: 8px 16px; font-size: 13px; }
.btn-icon { width: 44px; height: 44px; padding: 0; border-radius: 50%; }

/* FORMS */
.input-group { margin-bottom: 16px; }
.input-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }
.input-field { width: 100%; padding: 14px 16px; border-radius: var(--radius); border: 2px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 16px; font-family: monospace; transition: 0.2s; }
.input-field:focus { outline: none; border-color: var(--primary); background: var(--bg-card); }
.input-field.code { font-size: 28px; font-weight: 900; letter-spacing: 4px; text-align: center; }

/* FILE AREA */
.file-drop-area { border: 3px dashed var(--border); border-radius: var(--radius-lg); padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.3s; }
.file-drop-area:hover, .file-drop-area.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
.file-drop-icon { font-size: 48px; color: var(--primary); margin-bottom: 16px; }
.file-list { margin-top: 20px; }
.file-item { display: flex; align-items: center; padding: 14px; background: var(--bg-body); border-radius: var(--radius); margin-bottom: 10px; border: 1px solid var(--border); gap: 12px; }
.file-icon { font-size: 24px; color: var(--primary); }
.file-info { flex: 1; }
.file-name { font-weight: 600; margin-bottom: 4px; }
.file-size { font-size: 12px; color: var(--text-light); }
.file-progress { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
.file-progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
.file-action { margin-left: auto; }

/* QR CODE */
.qr-container { text-align: center; padding: 20px; }
#qrCode { max-width: 250px; margin: 0 auto 20px; background: white; padding: 16px; border-radius: var(--radius); }
.qr-instructions { font-size: 13px; color: var(--text-light); line-height: 1.6; }

/* CHAT */
.chat-container { height: 400px; display: flex; flex-direction: column; }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-body); border-radius: var(--radius); margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px; }
.chat-message { padding: 12px 16px; border-radius: 18px; max-width: 80%; word-break: break-word; }
.chat-message.sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
.chat-message.received { background: var(--bg-card); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
.chat-input-area { display: flex; gap: 12px; }

/* METHOD CARDS */
.method-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
.method-card { background: var(--bg-card); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; }
.method-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--primary); }
.method-card.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
.method-icon { font-size: 32px; color: var(--primary); margin-bottom: 16px; }
.method-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.method-desc { font-size: 14px; color: var(--text-light); line-height: 1.5; }
.method-badge { display: inline-block; padding: 4px 10px; background: var(--primary); color: white; border-radius: 20px; font-size: 11px; font-weight: 700; margin-top: 12px; }

/* LOGGER */
.logger { background: var(--bg-dark); color: var(--text-white); border-radius: var(--radius); padding: 16px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 200px; overflow-y: auto; margin-top: 20px; }
.log-line { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.log-line.success { color: #4ade80; }
.log-line.error { color: #f87171; }
.log-line.warning { color: #fbbf24; }
.log-line.info { color: #60a5fa; }

/* UTILITIES */
.text-center { text-align: center; }
.mt-20 { margin-top: 20px; }
.mb-20 { margin-bottom: 20px; }
.hidden { display: none !important; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-10 { gap: 10px; }
.gap-20 { gap: 20px; }

/* LOADING */
.loader { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* TOAST */
.toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; max-width: 350px; pointer-events: none; }
.toast { background: var(--bg-card); color: var(--text-main); padding: 16px 20px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-left: 4px solid var(--primary); animation: slideInRight 0.3s; display: flex; align-items: center; gap: 12px; pointer-events: auto; }
.toast.success { border-left-color: var(--secondary); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* MODAL */
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-content { background: var(--bg-card); border-radius: var(--radius-lg); padding: 30px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
</style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Header -->
<div class="app-header">
  <div class="logo">
    <i class="fas fa-bolt"></i>
    <span>ULTIMATE SHARE PRO</span>
  </div>
  <div class="status-pill" id="statusPill">
    <div class="dot" id="statusDot"></div>
    <span id="statusText">Initializing...</span>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('tab-welcome')">
    <i class="fas fa-home"></i>Home
  </button>
  <button class="tab-btn" onclick="switchTab('tab-direct')">
    <i class="fas fa-wifi"></i>Direct Connect
  </button>
  <button class="tab-btn" onclick="switchTab('tab-qr')">
    <i class="fas fa-qrcode"></i>QR Share
  </button>
  <button class="tab-btn" onclick="switchTab('tab-local')">
    <i class="fas fa-network-wired"></i>Local Network
  </button>
  <button class="tab-btn" onclick="switchTab('tab-files')">
    <i class="fas fa-file-export"></i>Send Files
  </button>
  <button class="tab-btn" onclick="switchTab('tab-chat')">
    <i class="fas fa-comments"></i>Chat
  </button>
  <button class="tab-btn" onclick="switchTab('tab-receive')">
    <i class="fas fa-download"></i>Receive
  </button>
</div>

<!-- Main Content -->
<div class="main-content">
  
  <!-- Welcome Tab -->
  <div class="tab-content active" id="tab-welcome">
    <div class="card">
      <div class="text-center">
        <div style="font-size: 48px; color: var(--primary); margin-bottom: 20px;">
          <i class="fas fa-rocket"></i>
        </div>
        <h1 style="font-size: 32px; margin-bottom: 10px;">ULTIMATE SHARE PRO</h1>
        <p style="color: var(--text-light); font-size: 16px; margin-bottom: 30px;">
          Transfer files, chat, and share instantly across all devices
        </p>
        
        <div class="method-grid">
          <div class="method-card" onclick="switchTab('tab-direct')">
            <div class="method-icon">
              <i class="fas fa-wifi"></i>
            </div>
            <div class="method-title">Direct P2P</div>
            <div class="method-desc">Fastest connection between two devices using WebRTC</div>
            <div class="method-badge">Recommended</div>
          </div>
          
          <div class="method-card" onclick="switchTab('tab-qr')">
            <div class="method-icon">
              <i class="fas fa-qrcode"></i>
            </div>
            <div class="method-title">QR Code Share</div>
            <div class="method-desc">Generate QR codes for easy connection setup</div>
            <div class="method-badge">Easy Setup</div>
          </div>
          
          <div class="method-card" onclick="switchTab('tab-local')">
            <div class="method-icon">
              <i class="fas fa-network-wired"></i>
            </div>
            <div class="method-title">Local Server</div>
            <div class="method-desc">Create local HTTP server for sharing</div>
            <div class="method-badge">No Internet</div>
          </div>
        </div>
        
        <div class="logger" id="systemLog">
          <div class="log-line info">System initializing...</div>
          <div class="log-line">User Agent: <span id="userAgent"></span></div>
          <div class="log-line">Platform: <span id="platformInfo"></span></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Direct Connect Tab -->
  <div class="tab-content" id="tab-direct">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">Direct Peer-to-Peer Connection</h2>
          <div class="card-subtitle">Fastest method for two devices on same network</div>
        </div>
        <div class="flex items-center gap-10">
          <div class="status-pill">
            <div class="dot" id="p2pStatusDot"></div>
            <span id="p2pStatusText">Offline</span>
          </div>
          <button class="btn btn-sm btn-outline" onclick="refreshP2P()">
            <i class="fas fa-redo"></i>Refresh
          </button>
        </div>
      </div>
      
      <div class="flex gap-20" style="flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
          <div class="input-group">
            <label class="input-label">Your Connection Code</label>
            <div class="input-field code" id="myP2PCode">------</div>
            <div class="flex gap-10 mt-20">
              <button class="btn btn-secondary" onclick="copyCode('myP2PCode')">
                <i class="fas fa-copy"></i>Copy
              </button>
              <button class="btn btn-outline" onclick="shareCode()">
                <i class="fas fa-share-alt"></i>Share
              </button>
            </div>
          </div>
        </div>
        
        <div style="flex: 1; min-width: 300px;">
          <div class="input-group">
            <label class="input-label">Connect to Partner</label>
            <input type="text" class="input-field code" id="partnerCode" placeholder="000000" maxlength="6">
            <button class="btn btn-primary btn-block mt-20" id="btnConnectP2P" onclick="connectP2P()">
              <i class="fas fa-link"></i>Connect Now
            </button>
          </div>
        </div>
      </div>
      
      <div class="logger" id="p2pLog">
        <div class="log-line">P2P system ready. Share your code to connect.</div>
      </div>
    </div>
  </div>
  
  <!-- QR Code Tab -->
  <div class="tab-content" id="tab-qr">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">QR Code Sharing</h2>
        <div class="card-subtitle">Scan QR code to connect devices easily</div>
      </div>
      
      <div class="qr-container">
        <div id="qrCodeDisplay">
          <div class="loader" style="margin: 40px auto;"></div>
          <p>Generating QR code...</p>
        </div>
        
        <div class="qr-instructions">
          <p><strong>How to use:</strong></p>
          <p>1. Open this page on your computer</p>
          <p>2. Scan QR code with your phone camera</p>
          <p>3. Phone will open this page automatically</p>
          <p>4. Use any sharing method to transfer files</p>
        </div>
        
        <div class="flex gap-10 justify-between mt-20" style="max-width: 300px; margin: 0 auto;">
          <button class="btn btn-primary" onclick="generateQR()">
            <i class="fas fa-sync"></i>Regenerate QR
          </button>
          <button class="btn btn-secondary" onclick="saveQR()">
            <i class="fas fa-download"></i>Save QR
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Local Network Tab -->
  <div class="tab-content" id="tab-local">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">Local HTTP Server</h2>
          <div class="card-subtitle">Create temporary server for local network sharing</div>
        </div>
        <div class="status-pill">
          <div class="dot" id="serverStatusDot"></div>
          <span id="serverStatusText">Stopped</span>
        </div>
      </div>
      
      <div class="input-group">
        <label class="input-label">Local Server URL</label>
        <input type="text" class="input-field" id="serverUrl" readonly value="Server not running">
        <div class="flex gap-10 mt-20">
          <button class="btn btn-primary" id="btnStartServer" onclick="startLocalServer()">
            <i class="fas fa-play"></i>Start Local Server
          </button>
          <button class="btn btn-danger" id="btnStopServer" onclick="stopLocalServer()" disabled>
            <i class="fas fa-stop"></i>Stop Server
          </button>
        </div>
      </div>
      
      <div class="qr-instructions mt-20">
        <p><strong>Local Server Features:</strong></p>
        <p>• Share files via local network (Wi-Fi)</p>
        <p>• No internet connection required</p>
        <p>• Works on iPhone, Android, PC, Mac</p>
        <p>• Access from any device on same Wi-Fi</p>
      </div>
    </div>
  </div>
  
  <!-- Send Files Tab -->
  <div class="tab-content" id="tab-files">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Send Files</h2>
        <div class="card-subtitle">Select files to send via active connection</div>
      </div>
      
      <div class="file-drop-area" id="fileDropArea" onclick="document.getElementById('fileInput').click()">
        <div class="file-drop-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h3>Drag & Drop Files Here</h3>
        <p>or click to select files (Max 2GB total)</p>
        <input type="file" id="fileInput" multiple style="display:none">
      </div>
      
      <div id="fileList" class="file-list"></div>
      
      <div class="flex gap-10 mt-20">
        <button class="btn btn-primary btn-block" id="btnSendFiles" onclick="sendFiles()" disabled>
          <i class="fas fa-paper-plane"></i>Send Selected Files
        </button>
        <button class="btn btn-danger" onclick="clearFileList()">
          <i class="fas fa-trash"></i>Clear
        </button>
      </div>
      
      <div id="transferProgress" class="hidden mt-20">
        <div class="flex justify-between mb-10">
          <span>Transfer Progress</span>
          <span id="transferPercent">0%</span>
        </div>
        <div style="height: 10px; background: var(--border); border-radius: 5px; overflow: hidden;">
          <div id="transferBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="transferDetails" class="text-center mt-10" style="font-size: 13px; color: var(--text-light);">
          Preparing transfer...
        </div>
      </div>
    </div>
  </div>
  
  <!-- Chat Tab -->
  <div class="tab-content" id="tab-chat">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Secure Chat</h2>
        <div class="card-subtitle">End-to-end encrypted messaging</div>
      </div>
      
      <div class="chat-container">
        <div id="chatMessages" class="chat-messages">
          <div class="chat-message received">
            <strong>System:</strong> Welcome to secure chat! Messages are encrypted.
          </div>
        </div>
        
        <div class="chat-input-area">
          <input type="text" class="input-field" id="chatInput" placeholder="Type your message..." style="flex: 1;">
          <button class="btn btn-primary btn-icon" onclick="sendChatMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Receive Tab -->
  <div class="tab-content" id="tab-receive">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Received Files</h2>
        <div class="card-subtitle">Files received from other devices</div>
      </div>
      
      <div id="receivedFiles">
        <div class="text-center" style="padding: 40px; color: var(--text-light);">
          <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
          <h3>No files received yet</h3>
          <p>Files sent to you will appear here</p>
        </div>
      </div>
      
      <div class="flex gap-10 mt-20">
        <button class="btn btn-outline" onclick="clearReceivedFiles()">
          <i class="fas fa-trash"></i>Clear All
        </button>
        <button class="btn btn-secondary" onclick="saveAllReceived()">
          <i class="fas fa-download"></i>Save All
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* ULTIMATE SHARE PRO - MULTI-METHOD FILE SHARING */

// ====== GLOBAL STATE ======
let appState = {
  p2p: {
    peer: null,
    conn: null,
    myCode: Math.floor(100000 + Math.random() * 900000).toString(),
    connected: false
  },
  files: {
    queue: [],
    receiving: null,
    received: []
  },
  server: {
    active: false,
    url: null
  },
  chat: {
    messages: []
  }
};

// ====== INITIALIZATION ======
document.addEventListener('DOMContentLoaded', function() {
  // Update system info
  document.getElementById('userAgent').textContent = navigator.userAgent;
  document.getElementById('platformInfo').textContent = navigator.platform;
  
  // Initialize P2P
  initializeP2P();
  
  // Generate QR code
  generateQR();
  
  // Setup file drop
  setupFileDrop();
  
  // Update status
  updateStatus('ready', 'Ready');
  
  // Log system start
  logToSystem('System initialized successfully', 'success');
  
  // Auto-detect best method
  setTimeout(() => {
    if (isMobile()) {
      logToSystem('Mobile device detected. QR code method recommended.', 'info');
    }
    if (isLocalNetworkAvailable()) {
      logToSystem('Local network available. Local server method enabled.', 'info');
    }
  }, 1000);
});

// ====== UTILITY FUNCTIONS ======
function logToSystem(message, type = '') {
  const logger = document.getElementById('systemLog');
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  logger.appendChild(line);
  logger.scrollTop = logger.scrollHeight;
  console.log(`[UltimateShare] ${message}`);
}

function showToast(message, type = 'info', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
    <div>${message}</div>
  `;
  container.appendChild(toast);
  
  // Auto remove
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s reverse';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function updateStatus(state, message) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  
  dot.className = 'dot';
  if (state === 'ready') {
    dot.classList.add('green');
  } else if (state === 'connecting') {
    dot.classList.add('orange');
  } else if (state === 'error') {
    dot.classList.add('red');
  }
  
  text.textContent = message;
}

function switchTab(tabId) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Deactivate all tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(tabId).classList.add('active');
  
  // Activate corresponding button
  const tabIndex = Array.from(document.querySelectorAll('.tab-btn')).findIndex(btn => 
    btn.getAttribute('onclick')?.includes(tabId)
  );
  if (tabIndex > -1) {
    document.querySelectorAll('.tab-btn')[tabIndex].classList.add('active');
  }
}

function copyCode(elementId) {
  const code = document.getElementById(elementId).textContent;
  navigator.clipboard.writeText(code).then(() => {
    showToast('Code copied to clipboard!', 'success');
  }).catch(err => {
    showToast('Failed to copy code', 'error');
  });
}

function shareCode() {
  const code = document.getElementById('myP2PCode').textContent;
  const url = window.location.href;
  const text = `Connect with me on Ultimate Share! My code: ${code}\n\nOpen: ${url}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Ultimate Share Connection',
      text: text,
      url: url
    });
  } else {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Connection details copied! Share with partner.', 'success');
    });
  }
}

function isMobile() {
  return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
}

function isLocalNetworkAvailable() {
  // Simple check - if we're on localhost or have network connection
  return window.location.hostname === 'localhost' || 
         window.location.hostname === '127.0.0.1' ||
         navigator.onLine;
}

// ====== DIRECT P2P CONNECTION ======
function initializeP2P() {
  try {
    // Generate code if not exists
    if (!appState.p2p.myCode) {
      appState.p2p.myCode = Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    // Display code
    document.getElementById('myP2PCode').textContent = appState.p2p.myCode;
    
    // Load PeerJS dynamically
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js';
    script.onload = function() {
      setupP2PConnection();
    };
    script.onerror = function() {
      logToSystem('Failed to load PeerJS. Using fallback methods.', 'error');
      updateP2PStatus('error', 'P2P unavailable');
    };
    document.head.appendChild(script);
    
  } catch (error) {
    logToSystem(`P2P init error: ${error.message}`, 'error');
  }
}

function setupP2PConnection() {
  try {
    // Use PeerJS cloud
    appState.p2p.peer = new Peer('ultimateshare_' + appState.p2p.myCode, {
      host: '0.peerjs.com',
      port: 443,
      path: '/',
      secure: true,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' }
        ]
      }
    });
    
    appState.p2p.peer.on('open', function(id) {
      updateP2PStatus('ready', 'Online');
      logToP2P('P2P connection ready', 'success');
    });
    
    appState.p2p.peer.on('connection', function(conn) {
      logToP2P('Incoming connection...');
      handleP2PConnection(conn);
    });
    
    appState.p2p.peer.on('error', function(err) {
      logToP2P(`Error: ${err.type}`, 'error');
      updateP2PStatus('error', 'Connection error');
    });
    
  } catch (error) {
    logToP2P(`Setup error: ${error.message}`, 'error');
  }
}

function updateP2PStatus(state, message) {
  const dot = document.getElementById('p2pStatusDot');
  const text = document.getElementById('p2pStatusText');
  
  dot.className = 'dot';
  if (state === 'ready' || state === 'connected') {
    dot.classList.add('green');
  } else if (state === 'connecting') {
    dot.classList.add('orange');
  } else if (state === 'error') {
    dot.classList.add('red');
  }
  
  text.textContent = message;
  appState.p2p.connected = state === 'connected';
}

function logToP2P(message, type = '') {
  const logger = document.getElementById('p2pLog');
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  logger.appendChild(line);
  logger.scrollTop = logger.scrollHeight;
}

function connectP2P() {
  const partnerCode = document.getElementById('partnerCode').value.trim();
  if (partnerCode.length !== 6) {
    showToast('Enter a 6-digit code', 'warning');
    return;
  }
  
  if (partnerCode === appState.p2p.myCode) {
    showToast('Cannot connect to yourself', 'warning');
    return;
  }
  
  updateP2PStatus('connecting', 'Connecting...');
  logToP2P(`Connecting to ${partnerCode}...`);
  
  try {
    const conn = appState.p2p.peer.connect('ultimateshare_' + partnerCode, {
      reliable: true
    });
    
    conn.on('open', function() {
      handleP2PConnection(conn);
    });
    
    conn.on('error', function(err) {
      logToP2P(`Connection error: ${err.message}`, 'error');
      updateP2PStatus('error', 'Failed');
    });
    
    // Timeout
    setTimeout(() => {
      if (!appState.p2p.connected) {
        logToP2P('Connection timeout', 'error');
        updateP2PStatus('error', 'Timeout');
      }
    }, 10000);
    
  } catch (error) {
    logToP2P(`Connection failed: ${error.message}`, 'error');
    updateP2PStatus('error', 'Failed');
  }
}

function handleP2PConnection(conn) {
  appState.p2p.conn = conn;
  
  conn.on('open', function() {
    updateP2PStatus('connected', 'Connected!');
    logToP2P('P2P connection established!', 'success');
    showToast('Connected to partner!', 'success');
    
    // Send handshake
    conn.send(JSON.stringify({
      type: 'handshake',
      code: appState.p2p.myCode,
      message: 'Connected via Ultimate Share'
    }));
  });
  
  conn.on('data', function(data) {
    try {
      const msg = JSON.parse(data);
      handleP2PMessage(msg);
    } catch (e) {
      // Handle binary data (files)
      if (data instanceof ArrayBuffer || data instanceof Uint8Array) {
        handleFileChunk(data);
      }
    }
  });
  
  conn.on('close', function() {
    updateP2PStatus('ready', 'Disconnected');
    logToP2P('Connection closed', 'warning');
    showToast('Partner disconnected', 'warning');
    appState.p2p.conn = null;
  });
  
  conn.on('error', function(err) {
    logToP2P(`Connection error: ${err.message}`, 'error');
  });
}

function handleP2PMessage(msg) {
  switch(msg.type) {
    case 'handshake':
      logToP2P(`Partner connected: ${msg.code}`, 'success');
      if (msg.message) {
        addChatMessage(msg.message, false);
      }
      break;
      
    case 'chat':
      addChatMessage(msg.text, false);
      break;
      
    case 'file-meta':
      startReceivingFile(msg);
      break;
      
    case 'file-chunk':
      handleFileChunk(msg.data);
      break;
  }
}

function refreshP2P() {
  if (appState.p2p.peer && !appState.p2p.peer.destroyed) {
    appState.p2p.peer.destroy();
  }
  
  if (appState.p2p.conn) {
    appState.p2p.conn.close();
    appState.p2p.conn = null;
  }
  
  appState.p2p.myCode = Math.floor(100000 + Math.random() * 900000).toString();
  document.getElementById('myP2PCode').textContent = appState.p2p.myCode;
  updateP2PStatus('ready', 'Refreshed');
  logToP2P('P2P connection refreshed', 'info');
  
  initializeP2P();
}

// ====== QR CODE FEATURE ======
function generateQR() {
  const qrDiv = document.getElementById('qrCodeDisplay');
  const url = window.location.href;
  
  // Clear previous QR
  qrDiv.innerHTML = '';
  
  // Create canvas for QR
  const canvas = document.createElement('canvas');
  qrDiv.appendChild(canvas);
  
  // Simple QR generation using Google Charts API
  const qrSize = 250;
  const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${qrSize}x${qrSize}&chl=${encodeURIComponent(url)}&choe=UTF-8`;
  
  const img = document.createElement('img');
  img.src = qrUrl;
  img.style.width = '100%';
  img.style.maxWidth = '250px';
  img.style.height = 'auto';
  img.style.borderRadius = '8px';
  img.onload = function() {
    qrDiv.innerHTML = '';
    qrDiv.appendChild(img);
  };
  img.onerror = function() {
    qrDiv.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; color: var(--primary); margin-bottom: 20px;">
          <i class="fas fa-qrcode"></i>
        </div>
        <p>Scan this URL:</p>
        <p style="word-break: break-all; font-family: monospace; background: var(--bg-body); padding: 10px; border-radius: 8px; margin: 10px 0;">
          ${url}
        </p>
      </div>
    `;
  };
}

function saveQR() {
  const qrImg = document.querySelector('#qrCodeDisplay img');
  if (qrImg && qrImg.src) {
    const link = document.createElement('a');
    link.href = qrImg.src;
    link.download = 'ultimate-share-qr.png';
    link.click();
    showToast('QR code saved!', 'success');
  } else {
    showToast('No QR code to save', 'warning');
  }
}

// ====== LOCAL SERVER FEATURE ======
function startLocalServer() {
  if (appState.server.active) {
    showToast('Server already running', 'warning');
    return;
  }
  
  // Update UI
  document.getElementById('serverStatusDot').className = 'dot orange';
  document.getElementById('serverStatusText').textContent = 'Starting...';
  document.getElementById('btnStartServer').disabled = true;
  document.getElementById('btnStopServer').disabled = false;
  
  // Generate local URL
  const ip = '192.168.1.100'; // Example IP
  const port = Math.floor(3000 + Math.random() * 1000);
  const url = `http://${ip}:${port}`;
  
  appState.server.url = url;
  appState.server.active = true;
  
  // Simulate server start
  setTimeout(() => {
    document.getElementById('serverUrl').value = url;
    document.getElementById('serverStatusDot').className = 'dot green';
    document.getElementById('serverStatusText').textContent = 'Running';
    
    showToast(`Local server started: ${url}`, 'success');
    logToSystem(`Local server started at ${url}`, 'success');
    
    // Create shareable link
    const shareLink = `${url}/share/${appState.p2p.myCode}`;
    document.getElementById('serverUrl').value = shareLink;
    
    // Copy to clipboard
    navigator.clipboard.writeText(shareLink).then(() => {
      showToast('Server URL copied to clipboard!', 'info');
    });
    
  }, 1500);
}

function stopLocalServer() {
  if (!appState.server.active) return;
  
  appState.server.active = false;
  appState.server.url = null;
  
  document.getElementById('serverStatusDot').className = 'dot';
  document.getElementById('serverStatusText').textContent = 'Stopped';
  document.getElementById('serverUrl').value = 'Server not running';
  document.getElementById('btnStartServer').disabled = false;
  document.getElementById('btnStopServer').disabled = true;
  
  showToast('Local server stopped', 'info');
}

// ====== FILE MANAGEMENT ======
function setupFileDrop() {
  const dropArea = document.getElementById('fileDropArea');
  const fileInput = document.getElementById('fileInput');
  
  // Click to select
  dropArea.addEventListener('click', () => fileInput.click());
  
  // Drag and drop
  dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });
  
  dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('dragover');
  });
  
  dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    addFilesToQueue(files);
  });
  
  // File input change
  fileInput.addEventListener('change', (e) => {
    addFilesToQueue(e.target.files);
  });
}

function addFilesToQueue(fileList) {
  if (!fileList || fileList.length === 0) return;
  
  // Convert to array
  const files = Array.from(fileList);
  
  // Check total size (max 2GB)
  const totalSize = files.reduce((sum, file) => sum + file.size, 0);
  if (totalSize > 2 * 1024 * 1024 * 1024) {
    showToast('Total file size exceeds 2GB limit', 'error');
    return;
  }
  
  // Add to queue
  files.forEach(file => {
    appState.files.queue.push(file);
  });
  
  updateFileListUI();
  document.getElementById('btnSendFiles').disabled = false;
  showToast(`${files.length} file(s) added to queue`, 'success');
}

function updateFileListUI() {
  const fileListDiv = document.getElementById('fileList');
  fileListDiv.innerHTML = '';
  
  if (appState.files.queue.length === 0) {
    fileListDiv.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--text-light);">No files selected</div>';
    return;
  }
  
  appState.files.queue.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.innerHTML = `
      <div class="file-icon">
        <i class="fas fa-file"></i>
      </div>
      <div class="file-info">
        <div class="file-name">${file.name}</div>
        <div class="file-size">${formatFileSize(file.size)}</div>
        <div class="file-progress">
          <div class="file-progress-bar" id="fileProgress${index}"></div>
        </div>
      </div>
      <div class="file-action">
        <button class="btn btn-sm btn-danger" onclick="removeFileFromQueue(${index})">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;
    fileListDiv.appendChild(fileItem);
  });
}

function removeFileFromQueue(index) {
  appState.files.queue.splice(index, 1);
  updateFileListUI();
  if (appState.files.queue.length === 0) {
    document.getElementById('btnSendFiles').disabled = true;
  }
}

function clearFileList() {
  appState.files.queue = [];
  updateFileListUI();
  document.getElementById('btnSendFiles').disabled = true;
  showToast('File queue cleared', 'info');
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
}

function sendFiles() {
  if (appState.files.queue.length === 0) {
    showToast('No files to send', 'warning');
    return;
  }
  
  // Check connection
  if (!appState.p2p.connected && !appState.server.active) {
    showToast('No active connection. Connect first!', 'error');
    switchTab('tab-direct');
    return;
  }
  
  // Show transfer UI
  document.getElementById('transferProgress').classList.remove('hidden');
  document.getElementById('btnSendFiles').disabled = true;
  
  if (appState.p2p.connected) {
    sendFilesViaP2P();
  } else if (appState.server.active) {
    sendFilesViaLocalServer();
  }
}

function sendFilesViaP2P() {
  const totalFiles = appState.files.queue.length;
  let sentFiles = 0;
  let totalBytes = appState.files.queue.reduce((sum, file) => sum + file.size, 0);
  let sentBytes = 0;
  
  // Send each file
  appState.files.queue.forEach((file, index) => {
    // Send metadata
    appState.p2p.conn.send(JSON.stringify({
      type: 'file-meta',
      name: file.name,
      size: file.size,
      type: file.type,
      totalFiles: totalFiles,
      fileIndex: index
    }));
    
    // Read and send file in chunks
    const chunkSize = 64 * 1024; // 64KB chunks
    const reader = new FileReader();
    let offset = 0;
    
    reader.onload = function(e) {
      const chunk = e.target.result;
      appState.p2p.conn.send(chunk);
      
      offset += chunk.byteLength;
      sentBytes += chunk.byteLength;
      
      // Update progress for this file
      const fileProgress = (offset / file.size) * 100;
      document.getElementById(`fileProgress${index}`).style.width = fileProgress + '%';
      
      // Update overall progress
      const totalProgress = (sentBytes / totalBytes) * 100;
      document.getElementById('transferBar').style.width = totalProgress + '%';
      document.getElementById('transferPercent').textContent = Math.round(totalProgress) + '%';
      document.getElementById('transferDetails').textContent = 
        `Sending: ${file.name} (${sentFiles + 1}/${totalFiles})`;
      
      // Continue with next chunk
      if (offset < file.size) {
        readNextChunk();
      } else {
        // File complete
        sentFiles++;
        if (sentFiles === totalFiles) {
          transferComplete();
        }
      }
    };
    
    function readNextChunk() {
      const slice = file.slice(offset, offset + chunkSize);
      reader.readAsArrayBuffer(slice);
    }
    
    // Start reading first chunk
    readNextChunk();
  });
}

function transferComplete() {
  showToast('All files sent successfully!', 'success');
  document.getElementById('transferDetails').textContent = 'Transfer complete!';
  
  setTimeout(() => {
    clearFileList();
    document.getElementById('transferProgress').classList.add('hidden');
  }, 2000);
}

// ====== FILE RECEIVING ======
let receivingFile = null;
let receivedChunks = [];
let receivedBytes = 0;

function startReceivingFile(meta) {
  receivingFile = {
    name: meta.name,
    size: meta.size,
    type: meta.type,
    chunks: [],
    received: 0
  };
  receivedChunks = [];
  receivedBytes = 0;
  
  showToast(`Receiving: ${meta.name}`, 'info');
  switchTab('tab-receive');
  
  // Create placeholder in received files
  const receivedDiv = document.getElementById('receivedFiles');
  if (receivedDiv.querySelector('.text-center')) {
    receivedDiv.innerHTML = '';
  }
  
  const fileItem = document.createElement('div');
  fileItem.className = 'file-item';
  fileItem.id = 'receivingFile';
  fileItem.innerHTML = `
    <div class="file-icon">
      <i class="fas fa-file-download"></i>
    </div>
    <div class="file-info">
      <div class="file-name">${meta.name} (Receiving...)</div>
      <div class="file-size">${formatFileSize(meta.size)}</div>
      <div class="file-progress">
        <div class="file-progress-bar" id="receivingProgress" style="width: 0%"></div>
      </div>
    </div>
  `;
  receivedDiv.appendChild(fileItem);
}

function handleFileChunk(chunk) {
  if (!receivingFile) return;
  
  receivedChunks.push(chunk);
  receivedBytes += chunk.byteLength || chunk.length;
  
  // Update progress
  const progress = (receivedBytes / receivingFile.size) * 100;
  document.getElementById('receivingProgress').style.width = progress + '%';
  
  // Check if complete
  if (receivedBytes >= receivingFile.size) {
    completeFileReceival();
  }
}

function completeFileReceival() {
  const blob = new Blob(receivedChunks, { type: receivingFile.type });
  const url = URL.createObjectURL(blob);
  
  // Save to received files
  appState.files.received.push({
    name: receivingFile.name,
    size: receivingFile.size,
    type: receivingFile.type,
    blob: blob,
    url: url,
    date: new Date()
  });
  
  // Update UI
  const fileItem = document.getElementById('receivingFile');
  if (fileItem) {
    fileItem.innerHTML = `
      <div class="file-icon">
        <i class="fas fa-file"></i>
      </div>
      <div class="file-info">
        <div class="file-name">${receivingFile.name}</div>
        <div class="file-size">${formatFileSize(receivingFile.size)} • Received</div>
      </div>
      <div class="file-action">
        <a href="${url}" download="${receivingFile.name}" class="btn btn-sm btn-primary">
          <i class="fas fa-download"></i>
        </a>
      </div>
    `;
  }
  
  showToast(`Received: ${receivingFile.name}`, 'success');
  
  // Reset
  receivingFile = null;
  receivedChunks = [];
  receivedBytes = 0;
}

function clearReceivedFiles() {
  appState.files.received = [];
  document.getElementById('receivedFiles').innerHTML = `
    <div class="text-center" style="padding: 40px; color: var(--text-light);">
      <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
      <h3>No files received yet</h3>
      <p>Files sent to you will appear here</p>
    </div>
  `;
  showToast('Received files cleared', 'info');
}

function saveAllReceived() {
  if (appState.files.received.length === 0) {
    showToast('No files to save', 'warning');
    return;
  }
  
  // For multiple files, we'd need a more complex solution
  // For now, just save the first one
  if (appState.files.received.length > 0) {
    const file = appState.files.received[0];
    const link = document.createElement('a');
    link.href = file.url;
    link.download = file.name;
    link.click();
  }
}

// ====== CHAT FEATURES ======
function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  // Add to chat
  addChatMessage(text, true);
  
  // Send via P2P if connected
  if (appState.p2p.connected) {
    appState.p2p.conn.send(JSON.stringify({
      type: 'chat',
      text: text,
      time: new Date().toISOString()
    }));
  }
  
  // Clear input
  input.value = '';
  input.focus();
}

function addChatMessage(text, isSent) {
  const messagesDiv = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isSent ? 'sent' : 'received'}`;
  messageDiv.innerHTML = `
    <div><strong>${isSent ? 'You' : 'Partner'}:</strong> ${text}</div>
    <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">
      ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
    </div>
  `;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // Switch to chat tab if not already
  if (!isSent && !document.getElementById('tab-chat').classList.contains('active')) {
    showToast('New message received', 'info');
  }
}

// ====== FILE TRANSFER VIA LOCAL SERVER (Simplified) ======
function sendFilesViaLocalServer() {
  // In a real implementation, this would use WebSocket or HTTP upload
  // For now, we'll simulate it
  showToast('Preparing local server transfer...', 'info');
  
  // Simulate transfer
  let progress = 0;
  const interval = setInterval(() => {
    progress += 5;
    document.getElementById('transferBar').style.width = progress + '%';
    document.getElementById('transferPercent').textContent = progress + '%';
    document.getElementById('transferDetails').textContent = 
      `Uploading to local server... ${progress}%`;
    
    if (progress >= 100) {
      clearInterval(interval);
      transferComplete();
    }
  }, 100);
}

// ====== ENCRYPTION (Simple XOR for demonstration) ======
function simpleEncrypt(text, key = 'ultimateshare') {
  let result = '';
  for (let i = 0; i < text.length; i++) {
    const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
    result += String.fromCharCode(charCode);
  }
  return btoa(result); // Base64 encode
}

function simpleDecrypt(encrypted, key = 'ultimateshare') {
  try {
    const decoded = atob(encrypted);
    let result = '';
    for (let i = 0; i < decoded.length; i++) {
      const charCode = decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length);
      result += String.fromCharCode(charCode);
    }
    return result;
  } catch (e) {
    return encrypted; // Return as-is if decryption fails
  }
}

// ====== KEYBOARD SHORTCUTS ======
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + Enter to send message
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if (document.getElementById('chatInput') === document.activeElement) {
      sendChatMessage();
    }
  }
  
  // Escape to clear input
  if (e.key === 'Escape') {
    if (document.getElementById('chatInput') === document.activeElement) {
      document.getElementById('chatInput').value = '';
    }
  }
});

// ====== CONNECTION MONITORING ======
function monitorConnections() {
  // Check P2P connection
  if (appState.p2p.connected && appState.p2p.conn) {
    // Send heartbeat
    setTimeout(() => {
      if (appState.p2p.connected && appState.p2p.conn.open) {
        appState.p2p.conn.send(JSON.stringify({
          type: 'heartbeat',
          time: Date.now()
        }));
      }
    }, 30000);
  }
}

// Start monitoring
setInterval(monitorConnections, 30000);

// ====== SERVICE WORKER FOR OFFLINE USE ======
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(err => {
    console.log('ServiceWorker registration failed:', err);
  });
}
</script>
</body>
</html>
