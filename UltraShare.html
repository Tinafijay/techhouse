<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>UltraShare Pro v7</title>
<meta name="theme-color" content="#ffffff">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
/* --- 1. MODERN CSS RESET & VARIABLES --- */
:root {
  --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;
  --bg-body: #f8fafc; --bg-card: #ffffff; --bg-surface: #f1f5f9;
  --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
  --success: #10b981; --error: #ef4444; --warning: #f59e0b;
  --radius-l: 16px; --radius-m: 12px; --radius-s: 8px;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
  --font: 'Inter', system-ui, -apple-system, sans-serif;
  --nav-height: 64px;
  --safe-bottom: env(safe-area-inset-bottom);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg-body: #0b0f19; --bg-card: #111827; --bg-surface: #1f2937;
    --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
    --primary: #3b82f6; --primary-light: #1e293b;
  }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
button { font-family: inherit; cursor: pointer; border: none; outline: none; }
input, select { font-family: inherit; outline: none; }

/* --- 2. APP LAYOUT --- */
.app-container { flex: 1; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px); }
.view { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s ease; }
.view.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Headers */
.header-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--bg-body); position: sticky; top: 0; z-index: 10; }
.app-logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
.status-badge { font-size: 11px; padding: 4px 8px; border-radius: 20px; background: var(--bg-surface); color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 4px; border: 1px solid var(--border); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--error); transition: 0.3s; }
.status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
.status-dot.connecting { background: var(--warning); animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* --- 3. COMPONENTS --- */
.card { background: var(--bg-card); border-radius: var(--radius-l); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 16px; }
.card h3 { margin: 0 0 8px 0; font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

.btn { width: 100%; padding: 14px; border-radius: var(--radius-m); font-weight: 600; font-size: 15px; transition: transform 0.1s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.2); }
.btn-secondary { background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border); }
.btn-success { background: var(--success); color: white; }
.btn-danger { background: var(--bg-surface); color: var(--error); border: 1px solid var(--border); }

.input-field { width: 100%; padding: 14px 16px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-m); color: var(--text-main); font-size: 18px; text-align: center; letter-spacing: 2px; font-family: monospace; transition: 0.2s; }
.input-field:focus { border-color: var(--primary); background: var(--bg-card); }

/* Drop Zone */
.drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-l); padding: 40px 20px; text-align: center; cursor: pointer; background: var(--bg-card); transition: 0.2s; }
.drop-zone:active { background: var(--bg-surface); border-color: var(--primary); }

/* File Items */
.file-item { display: flex; align-items: center; padding: 12px; background: var(--bg-surface); border-radius: var(--radius-m); margin-bottom: 8px; gap: 12px; border: 1px solid var(--border); }
.file-info { flex: 1; min-width: 0; }
.file-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-meta { font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between; margin-top: 2px; }
.progress-bar { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

/* Request Modal (New) */
.request-card { background: var(--primary-light); border: 1px solid var(--primary); animation: slideIn 0.3s; }
@keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Chat */
.chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; margin-bottom: 8px; }
.chat-bubble.mine { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
.chat-bubble.theirs { align-self: flex-start; background: var(--bg-surface); color: var(--text-main); border-bottom-left-radius: 4px; border: 1px solid var(--border); }

/* --- 4. NAVIGATION --- */
.nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-height) + var(--safe-bottom)); background: var(--bg-card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.03); z-index: 100; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px; font-weight: 500; gap: 4px; background: none; border: none; padding: 4px 0; }
.nav-item svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; }
.nav-item.active { color: var(--primary); }

/* --- 5. TOASTS --- */
.toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: 90%; max-width: 350px; }
.toast { background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 16px; border-radius: 12px; font-size: 14px; font-weight: 500; backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.hidden { display: none !important; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }

</style>
</head>
<body>

<div class="header-bar">
  <div class="app-logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
    UltraShare
  </div>
  <div class="status-badge">
    <div id="connectionDot" class="status-dot"></div>
    <span id="connectionText">Offline</span>
  </div>
</div>

<div class="app-container">

  <div id="view-connect" class="view active">
    <div class="card" style="text-align: center;">
      <h3>Your Connection Code</h3>
      <div style="font-size: 36px; font-weight: 800; color: var(--primary); letter-spacing: 6px; margin: 16px 0; font-family: monospace;" id="myIdDisplay">...</div>
      <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Share this code with the other device</div>
    </div>

    <div class="card">
      <h3>Connect to Partner</h3>
      <div style="display:flex; flex-direction:column; gap:16px;">
        <input id="destIdInput" type="text" inputmode="numeric" maxlength="6" class="input-field" placeholder="000000">
        <button id="connectBtn" class="btn btn-primary">Connect Now</button>
      </div>
      <div id="connectError" style="margin-top:12px; font-size:12px; color:var(--error); display:none; text-align:center; line-height:1.4;">
        Connection timed out. <br>Ensure both devices have internet. <br>If on restricted WiFi, try Mobile Data.
      </div>
    </div>
  </div>

  <div id="view-send" class="view">
    <div class="card" style="padding:0; overflow:hidden; border:none; box-shadow:none;">
      <div id="dropZone" class="drop-zone">
        <svg style="width: 48px; height: 48px; margin-bottom: 16px; color: var(--text-muted); opacity: 0.5;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">Tap to Select Files</div>
        <div style="color: var(--text-muted); font-size: 13px;">Photos, Videos, Documents</div>
        <input type="file" id="fileInput" multiple style="display:none">
      </div>
    </div>

    <div id="queueSection" class="hidden">
      <div id="transferStats" class="card hidden" style="background: var(--bg-surface);">
          <h3 id="transferStatus">Preparing...</h3>
          <div class="progress-bar"><div id="mainProgressBar" class="progress-fill"></div></div>
          <div style="font-size:12px; color:var(--text-muted); margin-top:6px; display:flex; justify-content:space-between;">
              <span id="transferCount"></span>
              <span id="transferSpeed"></span>
          </div>
      </div>
      
      <h3>Queue</h3>
      <div id="fileListContainer"></div>
      <button id="sendBtn" class="btn btn-primary" style="margin-top:16px;">Send Files</button>
    </div>
  </div>

  <div id="view-chat" class="view">
    <div class="card" style="height: calc(100vh - 180px); display:flex; flex-direction:column; padding:0; overflow:hidden;">
      <div style="padding:16px; border-bottom:1px solid var(--border); background:var(--bg-surface);">
        <h3 style="margin:0;">Chat & Clipboard</h3>
      </div>
      
      <div id="msgContainer" style="flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column;">
        <div class="empty-state">
          <div style="font-size:13px;">Messages and links appear here.</div>
        </div>
      </div>

      <div style="padding:12px; background:var(--bg-card); border-top:1px solid var(--border); display:flex; gap:8px;">
        <input id="msgInput" class="input-field" placeholder="Type..." style="font-size:15px; text-align:left; letter-spacing:0;" autocomplete="off">
        <button id="sendMsgBtn" class="btn btn-primary" style="width:auto; padding:0 20px;">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>
  
  <div id="view-receive" class="view">
    <div id="incomingRequestContainer"></div>
    
    <div class="card">
      <h3>Received Files</h3>
      <div id="receiveList">
        <div class="empty-state" style="padding: 10px; font-size: 13px;">No files received yet.</div>
      </div>
    </div>
  </div>

</div>

<nav class="nav-bar">
  <button class="nav-item active" data-target="view-connect">
    <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
    Connect
  </button>
  <button class="nav-item" data-target="view-send">
    <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    Send
  </button>
  <button class="nav-item" data-target="view-chat">
    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    Chat
  </button>
  <button class="nav-item" data-target="view-receive">
    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Receive
  </button>
</nav>

<div id="toastContainer" class="toast-container"></div>

<script>
/* ULTRA-SHARE V7 (Reliability Fix) */

// --- STATE & CONFIG ---
const $ = id => document.getElementById(id);
const myCode = Math.floor(100000 + Math.random() * 900000).toString(); 
const PEER_ID_PREFIX = 'us_v7_'; // Changed prefix to avoid version mismatch
const CHUNK_SIZE = 32 * 1024; // 32KB is safer for reliability
const MAX_BUFFER = 2 * 1024 * 1024; // 2MB buffer

let peer = null;
let conn = null;
let filesQueue = [];
let isSending = false;

// Receiving state
let incomingFileInfo = null;
let receivedChunks = [];
let receivedBytes = 0;

// --- 1. UI HELPERS ---
function toast(msg, type='info') {
  const t = document.createElement('div'); 
  t.className = 'toast';
  t.innerHTML = `${type==='success'?'‚úÖ':type==='error'?'‚ùå':type==='info'?'‚ÑπÔ∏è':'üõ†Ô∏è'} <span>${msg}</span>`;
  $('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function updateStatus(text, status) {
  // status: 'offline', 'connecting', 'online'
  $('connectionText').textContent = text;
  $('connectionDot').className = `status-dot ${status}`;
  
  if (status === 'online') {
    $('connectBtn').textContent = 'Connected';
    $('connectBtn').className = 'btn btn-success';
    $('destIdInput').disabled = true;
    $('connectError').style.display = 'none';
  } else if (status === 'connecting') {
    $('connectBtn').textContent = 'Connecting...';
    $('connectBtn').className = 'btn btn-primary';
    $('destIdInput').disabled = true;
  } else {
    $('connectBtn').textContent = 'Connect Now';
    $('connectBtn').className = 'btn btn-primary';
    $('destIdInput').disabled = false;
  }
}

function switchTab(tabId) {
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-target="${tabId}"]`).classList.add('active');
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  $(tabId).classList.add('active');
}

// --- 2. NETWORK LOGIC (Fixed) ---

function initNetwork() {
  $('myIdDisplay').textContent = '...';
  updateStatus('Initializing...', 'connecting');
  
  // FIX: Added secure:true and pingInterval for better stability
  peer = new Peer(PEER_ID_PREFIX + myCode, {
    debug: 1,
    secure: true, 
    pingInterval: 5000,
    config: {
      'iceServers': [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' }
      ]
    }
  });

  peer.on('open', (id) => {
    $('myIdDisplay').textContent = myCode;
    updateStatus('Ready to Pair', 'offline');
  });

  peer.on('error', (err) => {
    console.error('Peer Error:', err);
    updateStatus('Error', 'offline');
    if(err.type === 'unavailable-id') toast('ID Collision. Refresh page.', 'error');
    else toast('Network Error. Check internet.', 'error');
  });

  peer.on('connection', (c) => {
    toast('Incoming connection...', 'info');
    setupConnection(c);
  });
}

function setupConnection(c) {
  if (conn) conn.close();
  conn = c;

  conn.on('open', () => {
    updateStatus('Connected', 'online');
    toast('Connected successfully!', 'success');
  });

  conn.on('data', handleData);

  conn.on('close', () => {
    updateStatus('Disconnected', 'offline');
    toast('Partner disconnected', 'error');
    conn = null;
    isSending = false;
    $('transferStats').classList.add('hidden');
  });
  
  conn.on('error', (err) => {
    console.error('Conn Error:', err);
    updateStatus('Disconnected', 'offline');
  });
}

$('connectBtn').addEventListener('click', () => {
  const destCode = $('destIdInput').value.trim();
  if (destCode.length !== 6) return toast('Code must be 6 digits', 'error');
  if (destCode === myCode) return toast('Cannot connect to self', 'error');

  updateStatus('Connecting...', 'connecting');
  $('connectError').style.display = 'none';

  // Timeout failsafe
  const timeoutId = setTimeout(() => {
    if (!conn || !conn.open) {
      updateStatus('Timed Out', 'offline');
      $('connectError').style.display = 'block';
      toast('Connection timed out', 'error');
    }
  }, 10000);

  const c = peer.connect(PEER_ID_PREFIX + destCode, { reliable: true });
  
  c.on('open', () => {
    clearTimeout(timeoutId);
    setupConnection(c);
  });
  
  c.on('error', (err) => {
    clearTimeout(timeoutId);
    updateStatus('Failed', 'offline');
    toast('Connection failed', 'error');
  });
});

// --- 3. DATA HANDLER (The "Non-Blocking" Fix) ---

function handleData(data) {
  // If binary data (File Chunk)
  if (data instanceof ArrayBuffer || data instanceof Uint8Array) {
    if (!incomingFileInfo) return;
    receivedChunks.push(data);
    receivedBytes += data.byteLength;
    
    // Update Receiver Progress (Optional, could add UI here)
    if (receivedBytes >= incomingFileInfo.size) {
      finalizeReceive();
    }
    return;
  }

  // If text JSON data
  try {
    const msg = JSON.parse(data);
    
    switch(msg.type) {
      case 'chat':
        addChatMessage(msg.text, false);
        break;
        
      case 'file-offer':
        // FIX: Replaced confirm() with a custom UI request
        showFileRequest(msg);
        break;
        
      case 'file-accept':
        // Partner accepted, start sending
        startTransmission();
        break;
        
      case 'file-reject':
        toast('Partner rejected the file', 'error');
        isSending = false;
        $('transferStats').classList.add('hidden');
        filesQueue.shift(); // Remove rejected file
        renderQueue();
        break;
    }
  } catch(e) {
    console.error('Data parse error', e);
  }
}

// --- 4. CHAT ---
function addChatMessage(text, isMine) {
  const cont = $('msgContainer');
  if(cont.querySelector('.empty-state')) cont.innerHTML = '';
  
  const el = document.createElement('div');
  el.className = `chat-bubble ${isMine ? 'mine' : 'theirs'}`;
  el.textContent = text;
  cont.appendChild(el);
  cont.scrollTop = cont.scrollHeight;
  if (!isMine) switchTab('view-chat');
}

$('sendMsgBtn').addEventListener('click', () => {
  const txt = $('msgInput').value.trim();
  if(!txt) return;
  if(conn && conn.open) {
    conn.send(JSON.stringify({type: 'chat', text: txt}));
    addChatMessage(txt, true);
    $('msgInput').value = '';
  } else toast('Connect first!', 'error');
});

// --- 5. FILE TRANSFER (Robust Flow) ---

// UI for dropping files
$('dropZone').addEventListener('click', () => $('fileInput').click());
$('fileInput').addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    Array.from(e.target.files).forEach(f => filesQueue.push(f));
    renderQueue();
  }
});

function renderQueue() {
  const c = $('fileListContainer');
  c.innerHTML = '';
  if (filesQueue.length === 0) {
    $('queueSection').classList.add('hidden');
    return;
  }
  
  $('queueSection').classList.remove('hidden');
  $('sendBtn').textContent = `Send ${filesQueue.length} Files`;
  $('sendBtn').disabled = isSending;

  filesQueue.forEach((f, idx) => {
    const el = document.createElement('div');
    el.className = 'file-item';
    el.innerHTML = `
      <div style="font-size:20px;">üìÑ</div>
      <div class="file-info">
        <div class="file-name">${f.name}</div>
        <div class="file-meta">${formatBytes(f.size)}</div>
      </div>
      ${idx === 0 && isSending ? '<div style="font-size:12px;">Sending...</div>' : ''}
    `;
    c.appendChild(el);
  });
}

$('sendBtn').addEventListener('click', () => {
  if (!conn || !conn.open) return toast('Connect to a partner first!', 'error');
  if (filesQueue.length === 0) return;
  
  // Start the handshake
  const file = filesQueue[0];
  conn.send(JSON.stringify({
    type: 'file-offer',
    name: file.name,
    size: file.size,
    mime: file.type
  }));
  
  isSending = true;
  $('sendBtn').textContent = 'Waiting for Accept...';
  $('sendBtn').disabled = true;
});

async function startTransmission() {
  if (!filesQueue.length) return;
  
  $('transferStats').classList.remove('hidden');
  const file = filesQueue[0];
  const dc = conn.dataChannel;
  
  let offset = 0;
  const start = Date.now();
  
  $('transferStatus').textContent = `Sending ${file.name}`;
  
  // Loop through chunks
  while(offset < file.size) {
    const chunk = file.slice(offset, offset + CHUNK_SIZE);
    const buffer = await chunk.arrayBuffer();
    
    // BACKPRESSURE CONTROL: Prevent crash by waiting if buffer is full
    if (dc.bufferedAmount > MAX_BUFFER) {
      await new Promise(r => setTimeout(r, 10)); // wait 10ms
      continue; // check again
    }
    
    dc.send(buffer);
    offset += buffer.byteLength;
    
    // UI Update (Throttled slightly for performance)
    if (offset % (CHUNK_SIZE * 5) === 0 || offset >= file.size) {
      const pct = (offset/file.size)*100;
      $('mainProgressBar').style.width = pct + '%';
      const speed = ((offset/1024/1024) / ((Date.now() - start)/1000)).toFixed(1);
      $('transferSpeed').textContent = `${speed} MB/s`;
      $('transferCount').textContent = `${Math.round(pct)}%`;
    }
  }
  
  toast('File Sent!', 'success');
  filesQueue.shift();
  isSending = false;
  $('transferStats').classList.add('hidden');
  renderQueue();
  $('sendBtn').disabled = false;
  
  // Auto-trigger next file if queue not empty
  if(filesQueue.length > 0) $('sendBtn').click();
}

// --- 6. RECEIVING LOGIC (UI Based) ---

function showFileRequest(info) {
  switchTab('view-receive');
  const div = document.createElement('div');
  div.className = 'card request-card';
  div.innerHTML = `
    <h3>Incoming File Request</h3>
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <div style="font-size:24px;">üìÅ</div>
      <div>
        <div style="font-weight:700;">${info.name}</div>
        <div style="font-size:12px;">${formatBytes(info.size)}</div>
      </div>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn btn-danger" onclick="respondToFile(false, this)">Reject</button>
      <button class="btn btn-success" onclick="respondToFile(true, this)">Accept</button>
    </div>
  `;
  $('incomingRequestContainer').appendChild(div);
  
  // Save info to global scope so we know what we are receiving
  div.fileInfo = info;
}

window.respondToFile = (accepted, btn) => {
  const card = btn.closest('.card');
  const info = card.fileInfo;
  
  if (accepted) {
    incomingFileInfo = info;
    receivedChunks = [];
    receivedBytes = 0;
    toast(`Downloading ${info.name}...`, 'info');
    conn.send(JSON.stringify({ type: 'file-accept' }));
  } else {
    conn.send(JSON.stringify({ type: 'file-reject' }));
  }
  card.remove();
};

function finalizeReceive() {
  const blob = new Blob(receivedChunks, { type: incomingFileInfo.mime });
  const url = URL.createObjectURL(blob);
  
  const el = document.createElement('div');
  el.className = 'file-item';
  el.innerHTML = `
    <div style="font-size:20px;">‚¨á</div>
    <div class="file-info">
      <div class="file-name">${incomingFileInfo.name}</div>
      <div class="file-meta">${formatBytes(incomingFileInfo.size)}</div>
    </div>
    <a href="${url}" download="${incomingFileInfo.name}" class="btn btn-primary" style="width:auto; padding:8px 16px; font-size:12px;">Save</a>
  `;
  $('receiveList').prepend(el);
  document.querySelector('#receiveList .empty-state')?.remove();
  
  incomingFileInfo = null;
  receivedChunks = [];
  receivedBytes = 0;
  toast('Download Complete', 'success');
}

// Nav Logic
document.querySelectorAll('[data-target]').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.target));
});

initNetwork();
</script>
</body>
</html>