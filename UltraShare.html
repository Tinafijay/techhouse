<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>UltraShare Pro - Tech House</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }
        .container { max-width: 450px; margin: auto; background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .status-box { padding: 10px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; font-size: 0.9rem; background: #eee; }
        .id-label { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .id-val { font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: 3px; margin-bottom: 20px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .file-area { margin-top: 25px; border: 2px dashed #007bff; padding: 20px; border-radius: 15px; background: rgba(0,123,255,0.05); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; margin-top:0;">ðŸš€ UltraShare</h1>
    
    <div id="status" class="status-box">System: Starting...</div>

    <div style="text-align:center;">
        <div class="id-label">YOUR 6-DIGIT CODE</div>
        <div id="my-id" class="id-val">------</div>
    </div>

    <input type="number" id="peer-id-input" placeholder="Enter Partner's Code" pattern="\d*">
    <button id="connect-btn">ðŸ”— CONNECT DEVICES</button>

    <div class="file-area">
        <input type="file" id="file-input">
        <button id="send-btn" style="background:#28a745; margin-top:10px;">ðŸ“¤ SEND FILE</button>
    </div>
    
    <div id="logs" style="font-size:0.7rem; color:#888; margin-top:15px; text-align:left; max-height:60px; overflow-y:auto;"></div>
</div>

<script>
    const log = (msg) => {
        const div = document.getElementById('logs');
        div.innerHTML += `<div>> ${msg}</div>`;
        console.log(msg);
    };

    // Dark Mode Sync
    if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

    let peer;
    let conn;
    const shortId = Math.floor(100000 + Math.random() * 900000).toString();

    try {
        // We use a specific ID prefix to avoid conflicts
        peer = new Peer('TECHHOUSE-' + shortId);

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = shortId;
            document.getElementById('status').innerText = "ONLINE: SHARE YOUR CODE";
            document.getElementById('status').style.background = "#d4edda";
            log("Peer Server Connected");
        });

        peer.on('error', (err) => {
            document.getElementById('status').innerText = "ERROR: " + err.type;
            document.getElementById('status').style.background = "#f8d7da";
            log("Error: " + err.type);
        });

        // Handle Incoming
        peer.on('connection', (incoming) => {
            log("Incoming request...");
            conn = incoming;
            setupEvents();
        });
    } catch (e) {
        log("Init crash: " + e.message);
    }

    document.getElementById('connect-btn').onclick = () => {
        const target = document.getElementById('peer-id-input').value;
        if (target.length !== 6) {
            alert("Please enter a 6-digit code!");
            return;
        }
        
        document.getElementById('status').innerText = "CONNECTING...";
        log("Attempting to link to " + target);
        
        // Connecting to the partner
        conn = peer.connect('TECHHOUSE-' + target, {
            reliable: true
        });
        
        setupEvents();
    };

    function setupEvents() {
        if (!conn) return;

        conn.on('open', () => {
            document.getElementById('status').innerText = "âœ… CONNECTED!";
            document.getElementById('status').style.background = "#28a745";
            document.getElementById('status').style.color = "white";
            log("Handshake successful!");
        });

        conn.on('data', (data) => {
            if (data.file) {
                log("Receiving: " + data.name);
                const blob = new Blob([data.file], { type: data.mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        conn.on('close', () => {
            document.getElementById('status').innerText = "DISCONNECTED";
            log("Connection closed");
        });
    }

    document.getElementById('send-btn').onclick = () => {
        const file = document.getElementById('file-input').files[0];
        
        if (!conn || !conn.open) {
            alert("NOT CONNECTED! Please link devices first.");
            return;
        }
        if (!file) {
            alert("SELECT A FILE FIRST!");
            return;
        }

        log("Sending " + file.name);
        const reader = new FileReader();
        reader.onload = (e) => {
            conn.send({
                file: e.target.result,
                name: file.name,
                mime: file.type
            });
            log("Sent!");
            alert("File sent successfully!");
        };
        reader.readAsArrayBuffer(file);
    };

    // Keepalive for iOS 16
    setInterval(() => {
        if (conn && conn.open) conn.send({ type: 'keepalive' });
    }, 3000);

</script>
</body>
</html>