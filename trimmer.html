<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tech House High-Speed Trimmer</title>
    
    <script src="coi-serviceworker.js"></script>
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>

    <style>
        body { font-family: system-ui, sans-serif; background-color: #0f172a; color: #f1f5f9; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: #1e293b; padding: 25px; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .status-box { background: #000; color: #4ade80; padding: 15px; font-family: monospace; margin: 20px 0; border-radius: 6px; border: 1px solid #334155; }
        .time-readout { font-size: 1.4rem; color: #fbbf24; font-weight: bold; margin: 10px 0; }
        video { width: 100%; background: #000; border-radius: 8px; margin-top: 10px; }
        button { width: 100%; padding: 15px; background: #38bdf8; color: #0f172a; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        button:disabled { background: #475569; color: #94a3b8; cursor: wait; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        .marker-info { display: flex; gap: 20px; margin-top: 15px; background: #334155; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ðŸŽ¬ Tech House Precision Cutter</h1>
    
    <div id="announcer" class="sr-only" aria-live="assertive"></div>

    <div id="status-display" class="status-box">Status: Loading Engine...</div>

    <input type="file" id="uploader" accept="video/*" aria-label="Upload Video">
    
    <video id="player" controls></video>

    <div class="time-readout" id="current-time">Time: 0m 0s</div>

    <div class="marker-info">
        <div>Start (S): <span id="start-val" style="color:#4ade80">Not Set</span></div>
        <div>End (E): <span id="end-val" style="color:#f87171">Not Set</span></div>
    </div>

    <button id="export-btn" disabled>EXPORT VIDEO (Press X)</button>

    <div style="margin-top:20px; font-size:0.9rem; opacity:0.8;">
        <strong>Shortcuts:</strong> Space (Play/Pause) | Arrows (10s) | Shift+Arrows (1s) | S (Start) | E (End) | X (Export)
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const player = document.getElementById('player');
    const uploader = document.getElementById('uploader');
    const statusDisp = document.getElementById('status-display');
    const announcer = document.getElementById('announcer');
    const startVal = document.getElementById('start-val');
    const endVal = document.getElementById('end-val');
    const timeDisp = document.getElementById('current-time');
    const exportBtn = document.getElementById('export-btn');

    let startTime = -1;
    let endTime = -1;
    let videoFile = null;

    // --- Helper Functions ---
    function announce(msg) {
        announcer.innerText = "";
        setTimeout(() => { announcer.innerText = msg; }, 50);
        statusDisp.innerText = "Status: " + msg;
    }

    function fmt(s) {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return `${m}m ${sec}s`;
    }

    // --- Start Engine ---
    (async () => {
        try {
            await ffmpeg.load();
            announce("Engine Ready. Please upload your video.");
        } catch (e) {
            announce("Engine Error. Ensure coi-serviceworker.js is in your GitHub folder.");
        }
    })();

    uploader.onchange = (e) => {
        videoFile = e.target.files[0];
        if (videoFile) {
            player.src = URL.createObjectURL(videoFile);
            exportBtn.disabled = false;
            announce(`Loaded ${videoFile.name}. Use Arrows to navigate.`);
        }
    };

    player.ontimeupdate = () => {
        timeDisp.innerText = "Time: " + fmt(player.currentTime);
    };

    // --- Keyboard Logic ---
    window.addEventListener('keydown', (e) => {
        const k = e.key.toLowerCase();
        
        if (k === ' ' || e.code === 'Space') {
            e.preventDefault();
            player.paused ? player.play() : player.pause();
        }
        else if (k === 'arrowright') {
            e.preventDefault();
            player.currentTime += (e.shiftKey ? 1 : 10);
            announce(fmt(player.currentTime));
        }
        else if (k === 'arrowleft') {
            e.preventDefault();
            player.currentTime -= (e.shiftKey ? 1 : 10);
            announce(fmt(player.currentTime));
        }
        else if (k === 's') {
            startTime = player.currentTime;
            startVal.innerText = fmt(startTime);
            announce("Start set at " + fmt(startTime));
        }
        else if (k === 'e') {
            endTime = player.currentTime;
            endVal.innerText = fmt(endTime);
            announce("End set at " + fmt(endTime));
        }
        else if (k === 'x') {
            if(!exportBtn.disabled) runExport();
        }
    });

    // --- The Process ---
    async function runExport() {
        if (startTime < 0 || endTime <= startTime) {
            return announce("Error: Set Start and End points first.");
        }

        exportBtn.disabled = true;
        announce("Mounting file from disk...");

        try {
            // Memory Optimization: Mounting WORKERFS
            ffmpeg.FS('mount', 'WORKERFS', { files: [videoFile] }, '/data');
            
            announce("Cutting video... Please stay on this tab.");

            // FAST CUT (-c copy)
            await ffmpeg.run(
                '-ss', startTime.toString(),
                '-to', endTime.toString(),
                '-i', '/data/' + videoFile.name,
                '-c', 'copy',
                'output.mp4'
            );

            announce("Saving to downloads...");
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
            const a = document.createElement('a');
            a.href = url;
            a.download = `cut_${videoFile.name}`;
            a.click();

            // Cleanup
            ffmpeg.FS('unmount', '/data');
            ffmpeg.FS('unlink', 'output.mp4');
            
            announce("Success! File saved.");
            exportBtn.disabled = false;
        } catch (err) {
            console.error(err);
            announce("Error: File too large or browser limit reached.");
            try { ffmpeg.FS('unmount', '/data'); } catch(e){}
            exportBtn.disabled = false;
        }
    }

    exportBtn.onclick = runExport;
</script>
</body>
</html>