<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tech House | Poisoning Detector</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Tech House Brand Vibes */
    :root { --primary: #006d3a; --bg: #f4f7f9; --card: #ffffff; --text: #222; --border: #cbd5e1; }
    [data-theme="dark"] { --primary: #006d3a; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; }
    [data-theme="midnight"] { --primary: #0a84ff; --bg: #010101; --card: #161b22; --text: #f0f6fc; --border: #30363d; }
    [data-theme="rose"] { --primary: #ff375f; --bg: #fff0f3; --card: #ffffff; --text: #1d1d1f; --border: #ffccd5; }

    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; transition: 0.4s; }
    .app-container { display: flex; flex-direction: column; height: 100vh; }

    /* The Smooth Slide Animation */
    .tab-pane { 
      display: none; height: 100%; overflow-y: auto; padding-bottom: 110px; box-sizing: border-box;
      animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .tab-pane.active { display: block; }

    .viewport { width: 90%; max-width: 500px; aspect-ratio: 1; margin: 15px auto; background: #000; border-radius: 24px; overflow: hidden; border: 4px solid var(--primary); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    video { width: 100%; height: 100%; object-fit: cover; }

    .main-btn { width: 85%; padding: 18px; background: var(--primary); color: #fff; border: none; border-radius: 16px; font-size: 1rem; font-weight: bold; display: block; margin: 10px auto; cursor: pointer; transition: 0.2s; text-align: center; }
    .main-btn:active { transform: scale(0.95); }

    .tab-bar { height: 85px; background: var(--card); border-top: 1px solid var(--border); display: flex; position: fixed; bottom: 0; width: 100%; z-index: 100; }
    .tab-btn { flex: 1; background: none; border: none; color: #888; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; }
    .tab-btn.active { color: var(--primary); transform: translateY(-3px); transition: 0.3s; }
    .tab-btn span { font-size: 1.4rem; margin-bottom: 4px; }

    .card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 16px; margin: 15px; }
    .input-field { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; }

    .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .action-select { width: 100%; background: var(--bg); color: var(--primary); border: 1px solid var(--primary); padding: 8px; border-radius: 8px; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

  <audio id="vista-chime" src="vista_startup.mp3" preload="auto"></audio>

  <div class="app-container">
    <div class="tab-content" style="flex:1;">
      
      <div id="panel-scan" class="tab-pane active">
        <div style="padding: 20px; text-align: center;">
          <h2 style="color:var(--primary)">Precision Scanner</h2>
          <div class="viewport"><video id="cam-feed" autoplay playsinline muted></video></div>
          <button class="main-btn" id="scan-trigger" onclick="processScan()">ANALYZE SAMPLE</button>
          <div id="status-text" style="padding:15px; font-weight:bold; opacity:0.8;">Awaiting visual data...</div>
        </div>
      </div>

      <div id="panel-history" class="tab-pane">
        <div style="padding: 20px;">
          <h2 style="color:var(--primary)">History Reports</h2>
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="main-btn" style="flex:3; margin:0;" onclick="generateFullReportPDF()">Export PDF</button>
            <button class="main-btn" style="flex:1; margin:0; background:#9b1c1c;" onclick="clearAll()">Wipe</button>
          </div>
          <div id="history-list"></div>
        </div>
      </div>

      <div id="panel-settings" class="tab-pane">
        <div style="padding: 20px;">
          <h2 style="color:var(--primary)">Settings</h2>
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <span>Vista Startup Sound</span>
              <label class="switch">
                <input type="checkbox" id="sound-toggle" checked onchange="saveCheckboxes()">
                <span class="slider"></span>
              </label>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <span>Haptic Vibe</span>
              <label class="switch">
                <input type="checkbox" id="vibrate-toggle" checked onchange="saveCheckboxes()">
                <span class="slider"></span>
              </label>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <span>Location Tracking</span>
              <label class="switch">
                <input type="checkbox" id="location-toggle" checked onchange="toggleLocation()">
                <span class="slider"></span>
              </label>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <label>Theme</label>
            <select id="theme-select" class="input-field" onchange="updateTheme()">
              <option value="light">Tech House Light</option>
              <option value="dark">Tech House Dark</option>
              <option value="midnight">Midnight Pro</option>
              <option value="rose">Rose Gold</option>
            </select>
            <label>Gemini API Key</label>
            <input type="password" id="api-key" class="input-field" placeholder="Enter key here">
            <button class="main-btn" onclick="saveSettings()">Save Configuration</button>
          </div>
        </div>
      </div>
    </div>

    <nav class="tab-bar">
      <button id="nav-scan" class="tab-btn active" onclick="switchTab('panel-scan', this)"><span>üì∑</span>SCAN</button>
      <button id="nav-history" class="tab-btn" onclick="switchTab('panel-history', this)"><span>üìú</span>HISTORY</button>
      <button id="nav-settings" class="tab-btn" onclick="switchTab('panel-settings', this)"><span>‚öôÔ∏è</span>SETTINGS</button>
    </nav>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    let camStream = null, lastCoords = { lat: 0, lng: 0 };

    window.onload = () => {
      document.getElementById('api-key').value = localStorage.getItem('th_key') || "";
      document.getElementById('theme-select').value = localStorage.getItem('th_theme') || 'light';
      document.getElementById('sound-toggle').checked = localStorage.getItem('th_sound') !== 'false';
      document.getElementById('vibrate-toggle').checked = localStorage.getItem('th_vibrate') !== 'false';
      const locOn = localStorage.getItem('th_loc') !== 'false';
      document.getElementById('location-toggle').checked = locOn;
      
      updateTheme();
      initCam(); 
      loadHistory();
      if(locOn) startGps();
    };

    function saveCheckboxes() {
      localStorage.setItem('th_sound', document.getElementById('sound-toggle').checked);
      localStorage.setItem('th_vibrate', document.getElementById('vibrate-toggle').checked);
    }

    function toggleLocation() {
      const isOn = document.getElementById('location-toggle').checked;
      localStorage.setItem('th_loc', isOn);
      if(isOn) startGps();
      else lastCoords = { lat: 0, lng: 0 };
    }

    function startGps() {
      navigator.geolocation.watchPosition(p => {
        lastCoords = { lat: p.coords.latitude, lng: p.coords.longitude };
      }, null, { enableHighAccuracy: true });
    }

    function updateTheme() {
      const t = document.getElementById('theme-select').value;
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('th_theme', t);
    }

    async function initCam() {
      try {
        if (camStream) camStream.getTracks().forEach(t => t.stop());
        camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('cam-feed').srcObject = camStream;
      } catch (e) {
        document.getElementById('status-text').innerText = "Camera error: Enable permissions.";
      }
    }

    async function processScan() {
      const key = localStorage.getItem('th_key');
      if(!key) { alert("Add your Gemini API key in Settings first!"); return; }
      
      const statusText = document.getElementById('status-text');
      statusText.innerText = "Processing visual data...";
      
      try {
        const video = document.getElementById('cam-feed');
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        const base64Image = canvas.toDataURL("image/jpeg").split(",")[1];

        // Ensure we are using the correct endpoint and payload structure
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
        
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: "Food safety screening: Is there visible spoilage, toxins, or contamination? 1-sentence verdict." },
                { inline_data: { mime_type: "image/jpeg", data: base64Image } }
              ]
            }]
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error("Gemini Error:", errorData);
          throw new Error("API Refusal");
        }

        const data = await response.json();
        const verdict = data.candidates[0].content.parts[0].text;

        // Vibe Triggers: Sound & Vibrate
        if (document.getElementById('vibrate-toggle').checked && navigator.vibrate) navigator.vibrate(200);
        if (document.getElementById('sound-toggle').checked) {
          const chime = document.getElementById('vista-chime');
          chime.currentTime = 0;
          chime.play().catch(() => console.log("Sound interaction needed"));
        }

        statusText.innerText = verdict;
        speak(verdict);
        saveReport(verdict);
      } catch (err) {
        console.error(err);
        statusText.innerText = "Scan Failed. Check key/connection.";
      }
    }

    function saveReport(txt) {
      const h = JSON.parse(localStorage.getItem('th_hist') || '[]');
      const locOn = document.getElementById('location-toggle').checked;
      h.unshift({ 
        id: Date.now(), txt, date: new Date().toLocaleString(),
        lat: locOn ? lastCoords.lat : null, lng: locOn ? lastCoords.lng : null
      });
      localStorage.setItem('th_hist', JSON.stringify(h.slice(0, 50)));
      loadHistory();
    }

    function loadHistory() {
      const list = document.getElementById('history-list');
      const h = JSON.parse(localStorage.getItem('th_hist') || '[]');
      list.innerHTML = h.map((item, i) => `
        <div class="card">
          <small style="opacity:0.6">${item.date}</small>
          <p><strong>${item.txt}</strong></p>
          <select class="action-select" onchange="handleAction(this, ${i})">
            <option value="">Actions...</option>
            <option value="share">Share Report</option>
            <option value="pdf">Download PDF</option>
            ${item.lat ? '<option value="map">View Map</option>' : ''}
            <option value="delete">Delete</option>
          </select>
        </div>`).join('') || "<p style='text-align:center'>History is clear.</p>";
    }

    function handleAction(el, i) {
      const h = JSON.parse(localStorage.getItem('th_hist'));
      const item = h[i];
      if(el.value === 'share') {
        if(navigator.share) navigator.share({ title: 'Safety Alert', text: item.txt });
      } else if(el.value === 'pdf') {
        const doc = new jsPDF();
        doc.text("Tech House Safety Report", 20, 20);
        doc.text(`Result: ${item.txt}`, 20, 40, { maxWidth: 160 });
        doc.save(`Report_${item.id}.pdf`);
      } else if(el.value === 'map') {
        window.open(`https://www.google.com/maps?q=${item.lat},${item.lng}`, '_blank');
      } else if(el.value === 'delete') {
        h.splice(i, 1);
        localStorage.setItem('th_hist', JSON.stringify(h));
        loadHistory();
      }
      el.value = "";
    }

    function generateFullReportPDF() {
      const h = JSON.parse(localStorage.getItem('th_hist') || '[]');
      if(!h.length) return alert("Nothing to export!");
      const doc = new jsPDF();
      doc.text("Full Safety History", 20, 20);
      let y = 30;
      h.forEach(item => {
        if(y > 280) { doc.addPage(); y = 20; }
        doc.setFontSize(10);
        doc.text(`${item.date}: ${item.txt}`, 20, y, { maxWidth: 170 });
        y += 12;
      });
      doc.save("TechHouse_History.pdf");
    }

    function switchTab(id, el) {
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      el.classList.add('active');
    }

    function saveSettings() {
      localStorage.setItem('th_key', document.getElementById('api-key').value.trim());
      alert("Settings saved!");
    }

    function speak(t) { 
      window.speechSynthesis.cancel(); 
      window.speechSynthesis.speak(new SpeechSynthesisUtterance(t)); 
    }
    
    function clearAll() { 
      if(confirm("Wipe everything?")) { localStorage.removeItem('th_hist'); loadHistory(); } 
    }
  </script>
</body>
</html>